<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title th:text="${title}">ToDoLab</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <!-- flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_green.css">
</head>

<body class="bg-[#F7F6F2] h-screen flex flex-col">

<header class="w-full py-6 text-center shrink-0">
    <h1 class="text-3xl font-bold" th:text="${headerTitle}">ToDoLab</h1>
</header>

<main class="flex-1 w-full max-w-7xl mx-auto overflow-y-auto pb-28">
    <div th:utext="${body}"></div>
</main>

<!-- + ë²„íŠ¼ -->
<a id="floatingCreateBtn"
   href="/tasks/create"
   class="fixed bottom-24 right-10 bg-blue-600 text-white w-14 h-14
          rounded-full flex items-center justify-center shadow-xl text-3xl z-50">
    +
</a>

<!-- í•˜ë‹¨ íƒ­ -->
<footer class="fixed bottom-0 inset-x-0 w-full bg-white py-4 border-t flex justify-around text-gray-500 text-sm z-40">
    <a href="/tasks/day"
       th:classappend="${activeTab == 'day'} ? ' font-semibold text-blue-600' : ''"
       class="hover:text-black">ì¼</a>
    <a href="/tasks/week"
       th:classappend="${activeTab == 'week'} ? ' font-semibold text-blue-600' : ''"
       class="hover:text-black">ì£¼</a>
    <a href="/tasks/month"
       th:classappend="${activeTab == 'month'} ? ' font-semibold text-blue-600' : ''"
       class="hover:text-black">ì›”</a>
</footer>

<!-- ì„±ê³µ ëª¨ë‹¬/í† ìŠ¤íŠ¸ -->
<div id="successModal"
     class="fixed inset-0 hidden bg-black/40 flex items-center justify-center z-50">
    <div class="bg-white shadow-xl rounded-xl px-6 py-5 text-center animate-fade-in">
        <div class="text-4xl mb-2">ğŸ‰</div>
        <div class="text-lg font-bold mb-4">ì¼ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
        <button type="button" onclick="closeModal()"
                class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            í™•ì¸
        </button>
    </div>
</div>

<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-3"></div>

<style>
    @keyframes fade-in {
        from { opacity: 0; transform: scale(0.95); }
        to   { opacity: 1; transform: scale(1); }
    }
    .animate-fade-in { animation: fade-in 0.25s ease-out; }
</style>

<!-- ë“±ë¡ ëª¨ë‹¬ -->
<div id="appModal" class="fixed inset-0 hidden bg-black/40 z-50">
    <div id="appModalBackdrop" class="w-full h-full flex items-center justify-center p-4">
        <div id="appModalPanel"
             class="bg-white rounded-2xl shadow-2xl w-full max-w-lg flex flex-col overflow-hidden">

            <div class="flex items-center justify-between px-5 py-4 border-b shrink-0">
                <div class="font-bold text-gray-800">ì¼ì • ë“±ë¡</div>
                <button type="button" id="appModalCloseBtn"
                        class="text-gray-400 hover:text-gray-700 text-2xl leading-none">Ã—</button>
            </div>

            <div id="appModalContent" class="p-5 overflow-y-auto max-h-[65vh]"></div>

            <div id="appModalFooter" class="shrink-0 border-t bg-white">
                <div class="p-4">
                    <button id="submitBtn" type="button"
                            class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">
                        ì¼ì • ë“±ë¡
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- ìƒì„¸ ëª¨ë‹¬ -->
<div id="detailModal" class="fixed inset-0 hidden bg-black/40 z-50">
    <div id="detailModalBackdrop" class="w-full h-full flex items-center justify-center p-4">
        <div id="detailModalPanel"
             class="bg-white rounded-2xl shadow-2xl w-full max-w-lg flex flex-col overflow-hidden">

            <div class="flex items-center justify-between px-5 py-4 border-b shrink-0">
                <div class="font-bold text-gray-800">ì¼ì • ìƒì„¸</div>
                <button type="button" id="detailModalCloseBtn"
                        class="text-gray-400 hover:text-gray-700 text-2xl leading-none">Ã—</button>
            </div>

            <div id="detailModalContent" class="p-5 overflow-y-auto max-h-[70vh]"></div>

        </div>
    </div>
</div>

<!-- flatpickr -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>

<script>
    function openModal() {
        document.getElementById("successModal")?.classList.remove("hidden");
    }
    function closeModal() {
        document.getElementById("successModal")?.classList.add("hidden");
    }

    function showToast(message) {
        const container = document.getElementById("toast-container");
        if (!container) return;

        const toast = document.createElement("div");
        toast.className = "bg-black text-white px-4 py-2 rounded shadow-lg opacity-90 transition transform text-sm";
        toast.innerHTML = "âœ”ï¸ " + message;

        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.add("opacity-0");
            setTimeout(() => toast.remove(), 300);
        }, 2000);
    }

    // ë“±ë¡ ëª¨ë‹¬ (ì˜ˆì „ ì •ìƒ ë²„ì „ ìœ ì§€)
    const AppModal = (() => {
        const modal = () => document.getElementById("appModal");
        const content = () => document.getElementById("appModalContent");

        function open() {
            modal()?.classList.remove("hidden");
            document.body.style.overflow = "hidden";
        }

        function close() {
            modal()?.classList.add("hidden");
            document.body.style.overflow = "";
            if (content()) content().innerHTML = "";
        }

        async function loadCreate(date) {
            const url = date ? `/tasks/create?date=${encodeURIComponent(date)}` : `/tasks/create`;

            const res = await fetch(url, { headers: { "X-Requested-With": "fetch" }});
            const html = await res.text();

            content().innerHTML = html;
            open();

            initCreatePickersIfPresent(date);
            bindCreateSubmitIfPresent();
        }

        function initCreatePickersIfPresent(dateParam) {
            const dateInput = document.getElementById("dateInput");
            const timeSelect = document.getElementById("timeSelect");
            if (!dateInput || !timeSelect) return;

            if (dateInput._flatpickr) dateInput._flatpickr.destroy();
            if (timeSelect._flatpickr) timeSelect._flatpickr.destroy();

            flatpickr("#dateInput", {
                dateFormat: "Y-m-d",
                defaultDate: dateParam ?? "today",
                locale: "ko"
            });

            flatpickr("#timeSelect", {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                time_24hr: true,
                minuteIncrement: 30
            });
        }

        function bindCreateSubmitIfPresent() {
            const submitBtn = document.getElementById("submitBtn");
            const form = document.getElementById("taskForm");
            const errorBox = document.getElementById("error-box");
            if (!submitBtn || !form || !errorBox) return;

            submitBtn.onclick = () => form.requestSubmit();

            form.onsubmit = async (e) => {
                e.preventDefault();
                errorBox.classList.add("hidden");

                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = "â³ ë“±ë¡ ì¤‘...";

                const data = {
                    title: form.title?.value,
                    description: form.description?.value,
                    date: form.date?.value,
                    time: form.time?.value
                };

                let response;
                try {
                    response = await fetch("/tasks", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data)
                    });
                } catch (err) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    errorBox.innerText = "ì„œë²„ì™€ì˜ í†µì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                    errorBox.classList.remove("hidden");
                    return;
                }

                if (response.ok) {
                    submitBtn.innerHTML = "âœ” ë“±ë¡ ì™„ë£Œ";
                    showToast("ì¼ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    openModal();

                    form.reset();
                    AppModal.close();

                    setTimeout(() => window.location.reload(), 150);

                    setTimeout(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }, 500);
                } else {
                    const result = await response.json().catch(() => null);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;

                    errorBox.innerText = result?.message || "ë“±ë¡ ì‹¤íŒ¨";
                    errorBox.classList.remove("hidden");
                }
            };
        }

        function bindClose() {
            document.getElementById("appModalCloseBtn")?.addEventListener("click", close);
            document.getElementById("appModalBackdrop")?.addEventListener("click", (e) => {
                if (e.target?.id === "appModalBackdrop") close();
            });
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape" && !modal()?.classList.contains("hidden")) close();
            });
        }

        return { bindClose, loadCreate, close };
    })();

    // ìƒì„¸ ëª¨ë‹¬
    const DetailModal = (() => {
        const modal = () => document.getElementById("detailModal");
        const content = () => document.getElementById("detailModalContent");

        function open() {
            modal()?.classList.remove("hidden");
            document.body.style.overflow = "hidden";
        }

        function close() {
            modal()?.classList.add("hidden");
            document.body.style.overflow = "";
            if (content()) content().innerHTML = "";
        }

        async function loadDetail(taskId) {
            if (!taskId) return;

            const url = `/tasks/detail?id=${encodeURIComponent(taskId)}`;
            content().innerHTML = "<div class='text-gray-400 text-sm'>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>";

            let res;
            try {
                res = await fetch(url, { headers: { "X-Requested-With": "fetch" }});
            } catch (e) {
                showToast("ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                return;
            }

            if (!res.ok) {
                showToast("ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                return;
            }

            const html = await res.text();
            content().innerHTML = html;
            open();
        }

        function bindClose() {
            document.getElementById("detailModalCloseBtn")?.addEventListener("click", close);
            document.getElementById("detailModalBackdrop")?.addEventListener("click", (e) => {
                if (e.target?.id === "detailModalBackdrop") close();
            });
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape" && !modal()?.classList.contains("hidden")) close();
            });
        }

        return { bindClose, loadDetail, close };
    })();

    // detail.htmlì—ì„œ í˜¸ì¶œ
    function closeTaskDetailModal() {
        DetailModal.close();
    }

    document.addEventListener("DOMContentLoaded", () => {
        AppModal.bindClose();
        DetailModal.bindClose();

        const createBtn = document.getElementById("floatingCreateBtn");
        createBtn?.addEventListener("click", async (e) => {
            e.preventDefault();
            const dayPage = document.getElementById("day-page");
            const date = dayPage?.dataset?.date || null;
            await AppModal.loadCreate(date);
        });

        // ìƒì„¸ ì—´ê¸°: data-task-id í´ë¦­
        document.addEventListener("click", async (e) => {
            const el = e.target?.closest?.("[data-task-id]");
            if (!el) return;

            // ëª¨ë‹¬ ë‚´ë¶€ í´ë¦­/ë²„íŠ¼ ë“±ì— data-task-idê°€ ì‹¤ìˆ˜ë¡œ ìˆìœ¼ë©´ ë°©ì§€í•˜ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸°ì„œ í•„í„° ì¶”ê°€ ê°€ëŠ¥
            const taskId = el.getAttribute("data-task-id");
            await DetailModal.loadDetail(taskId);
        });
    });
</script>

</body>
</html>

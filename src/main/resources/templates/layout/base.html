<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title th:text="${title}">ToDoLab</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <!-- flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_green.css">
</head>

<body class="bg-[#F7F6F2] h-screen flex flex-col">

<header th:if="${showBaseHeader == null || showBaseHeader}"
        class="w-full py-6 text-center shrink-0">
    <h1 class="text-3xl font-bold" th:text="${headerTitle}">ToDoLab</h1>
</header>

<!-- âœ… í•˜ë‹¨ë°”(footer) + í”Œë¡œíŒ…ë²„íŠ¼ ì˜ì—­ ê³ ë ¤: padding-bottom ìœ ì§€ -->
<main class="flex-1 w-full max-w-7xl mx-auto overflow-y-auto pb-28">

    <!-- âœ… NEW: contentView(fragment include) ìš°ì„  -->
    <div th:if="${contentView != null}"
         th:replace="~{${contentView} :: content}"></div>

    <!-- âœ… BACKWARD COMPAT: ê¸°ì¡´ bodyHtml ë°©ì‹ ìœ ì§€ (ë¯¸ì •/ì£¼ê°„ ë“± ì˜í–¥ ìµœì†Œ) -->
    <div th:if="${contentView == null}"
         th:utext="${body}"></div>

</main>

<!-- + ë²„íŠ¼ -->
<a id="floatingCreateBtn"
   href="/tasks/create"
   class="fixed bottom-24 right-10 bg-blue-600 text-white w-14 h-14
          rounded-full flex items-center justify-center shadow-xl text-3xl z-50">
    +
</a>

<!-- âœ… í•˜ë‹¨ íƒ­ (3ê°œ): ë¯¸ì • / ì¼ / ì£¼ -->
<footer class="fixed bottom-0 inset-x-0 w-full bg-white py-4 border-t
               flex justify-around text-gray-500 text-sm z-40
               pb-[calc(env(safe-area-inset-bottom)+1rem)]">
    <a href="/tasks/unscheduled"
       th:classappend="${activeTab == 'unscheduled'} ? ' font-semibold text-blue-600' : ''"
       class="hover:text-black">
        ë¯¸ì •
    </a>
    <a href="/tasks/day"
       th:classappend="${activeTab == 'day'} ? ' font-semibold text-blue-600' : ''"
       class="hover:text-black">
        ì¼
    </a>
    <a href="/tasks/week"
       th:classappend="${activeTab == 'week'} ? ' font-semibold text-blue-600' : ''"
       class="hover:text-black">
        ì£¼
    </a>
</footer>

<!-- ì„±ê³µ ëª¨ë‹¬/í† ìŠ¤íŠ¸ -->
<div id="successModal"
     class="fixed inset-0 hidden bg-black/40 flex items-center justify-center z-50">
    <div class="bg-white shadow-xl rounded-xl px-6 py-5 text-center animate-fade-in">
        <div class="text-4xl mb-2">ğŸ‰</div>
        <div class="text-lg font-bold mb-4">ì¼ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
        <button type="button" onclick="closeModal()"
                class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            í™•ì¸
        </button>
    </div>
</div>

<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-3"></div>

<style>
    /* ê¸°ì¡´ ì• ë‹ˆë©”ì´ì…˜ ìœ ì§€ */
    @keyframes fade-in {
        from { opacity: 0; transform: scale(0.95); }
        to   { opacity: 1; transform: scale(1); }
    }
    .animate-fade-in { animation: fade-in 0.25s ease-out; }

    /* =========================
       ê³µí†µ UI ìŠ¤íƒ€ì¼ (day/week ê³µìš©)
       ========================= */

    /* ìƒë‹¨ ë„¤ë¹„ ë²„íŠ¼ (ì¢Œ/ìš° í™”ì‚´í‘œ) */
    .nav-btn{
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 14px;
        background: #fff;
        border: 1px solid #e5e7eb;
        box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        color: #111827;
        transition: transform .08s ease, background .15s ease;
    }
    .nav-btn:hover{ background: #fafafa; }
    .nav-btn:active{ transform: scale(0.98); }

    /* ì¹´ë“œ ì»¨í…Œì´ë„ˆ */
    .task-card{
        border-radius: 22px;
        background: #fff;
        border: 1px solid #e5e7eb;
        box-shadow: 0 10px 24px rgba(0,0,0,0.06);
        overflow: hidden;
    }

    /* ì¹´ë“œ ìƒë‹¨ íƒ€ì´í‹€ */
    .task-card-title{
        padding: 16px 18px 10px;
        font-weight: 800;
        color: #9ca3af;
    }

    /* ì£¼/ì¼ì • ë¦¬ìŠ¤íŠ¸ í–‰ */
    .task-row{
        display: flex;
        gap: 12px;
        padding: 14px 16px;
        align-items: center;
    }

    /* ì¢Œì¸¡ í¬ì¸íŠ¸ ë°” */
    .task-left-bar{
        width: 4px;
        align-self: stretch;
        border-radius: 9999px;
        opacity: 0.6;
    }

    /* ì²´í¬ë°•ìŠ¤ UI */
    .check-box{
        width: 24px;
        height: 24px;
        border-radius: 8px;
        background: #f3f4f6;
        color: #9ca3af;
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 0 0 auto;
    }

    .task-title{
        font-weight: 700;
        color: #374151;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .task-desc{
        font-size: 12px;
        color: #6b7280;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .task-time{
        font-size: 12px;
        color: #9ca3af;
    }

    .task-date{
        font-size: 12px;
        color: #9ca3af;
        font-weight: 700;
        white-space: nowrap;
        flex: 0 0 auto;
        margin-left: 10px;
    }

    /* ë¹ˆ ìƒíƒœ */
    .empty-state{
        border-radius: 22px;
        border: 1px dashed #d1d5db;
        padding: 24px;
        text-align: center;
        color: #6b7280;
        font-weight: 600;
        background: rgba(255,255,255,0.6);
    }

    /* â€œì˜¤ëŠ˜â€ ë°°ì§€ */
    .today-badge{
        font-size: 12px;
        padding: 4px 10px;
        border-radius: 9999px;
        background: #6366f1;
        color: #fff;
        font-weight: 800;
        line-height: 1;
    }

    /* í…ìŠ¤íŠ¸ ì¤„ì„ */
    .line-clamp-2{
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* day í˜ì´ì§€ ì‹œê°„ ë°°ì§€(ìƒ‰ìƒì€ inline styleë¡œ ì£¼ì…) */
    .time-badge{
        flex: 0 0 auto;
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 9999px;
        font-weight: 800;
        color: rgba(255,255,255,0.95);
        box-shadow: 0 6px 14px rgba(0,0,0,0.10);
        white-space: nowrap;
    }
</style>

<!-- ë“±ë¡ ëª¨ë‹¬ -->
<div id="appModal" class="fixed inset-0 hidden bg-black/40 z-50">
    <div id="appModalBackdrop" class="w-full h-full flex items-center justify-center p-4">
        <div id="appModalPanel"
             class="bg-white rounded-2xl shadow-2xl w-full max-w-lg flex flex-col overflow-hidden">

            <div class="flex items-center justify-between px-5 py-4 border-b shrink-0">
                <div class="font-bold text-gray-800">ì¼ì • ë“±ë¡</div>
                <button type="button" id="appModalCloseBtn"
                        class="text-gray-400 hover:text-gray-700 text-2xl leading-none">Ã—</button>
            </div>

            <div id="appModalContent" class="px-5 pb-5 pt-1 overflow-y-auto max-h-[65vh]"></div>

            <div id="appModalFooter" class="shrink-0 border-t bg-white">
                <div class="p-4">
                    <button id="submitBtn" type="button"
                            class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">
                        ì¼ì • ë“±ë¡
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- ìƒì„¸ ëª¨ë‹¬ -->
<div id="detailModal" class="fixed inset-0 hidden bg-black/40 z-50">
    <div id="detailModalBackdrop" class="w-full h-full flex items-center justify-center p-4">
        <div id="detailModalPanel"
             class="bg-white rounded-2xl shadow-2xl w-full max-w-lg flex flex-col overflow-hidden">

            <div class="flex items-center justify-between px-5 py-4 border-b shrink-0">
                <div class="font-bold text-gray-800">ì¼ì • ìƒì„¸</div>
                <button type="button" id="detailModalCloseBtn"
                        class="text-gray-400 hover:text-gray-700 text-2xl leading-none">Ã—</button>
            </div>

            <div id="detailModalContent" class="p-5 overflow-y-auto max-h-[70vh]"></div>

        </div>
    </div>
</div>

<!-- flatpickr -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>

<script>
    function openModal() {
        document.getElementById("successModal")?.classList.remove("hidden");
    }
    function closeModal() {
        document.getElementById("successModal")?.classList.add("hidden");
    }

    function showToast(message) {
        const container = document.getElementById("toast-container");
        if (!container) return;

        const toast = document.createElement("div");
        toast.className = "bg-black text-white px-4 py-2 rounded shadow-lg opacity-90 transition transform text-sm";
        toast.innerHTML = "âœ”ï¸ " + message;

        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.add("opacity-0");
            setTimeout(() => toast.remove(), 300);
        }, 2000);
    }

    // ===== util =====
    function toIsoLocalDateTime(dateStr, timeStr) {
        if (!dateStr) return null;
        const t = (timeStr && timeStr.trim()) ? timeStr.trim() : "00:00";
        return `${dateStr}T${t}:00`;
    }

    function addDays(dateStr, days) {
        const d = new Date(dateStr + "T00:00:00");
        d.setDate(d.getDate() + days);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd}`;
    }

    // ë“±ë¡ ëª¨ë‹¬
    const AppModal = (() => {
        const modal = () => document.getElementById("appModal");
        const content = () => document.getElementById("appModalContent");

        function open() {
            modal()?.classList.remove("hidden");
            document.body.style.overflow = "hidden";
        }

        function close() {
            modal()?.classList.add("hidden");
            document.body.style.overflow = "";
            if (content()) content().innerHTML = "";
        }

        async function loadCreate(date) {
            const url = date ? `/tasks/create?date=${encodeURIComponent(date)}` : `/tasks/create`;

            const res = await fetch(url, { headers: { "X-Requested-With": "fetch" }});
            const html = await res.text();

            content().innerHTML = html;
            open();

            initCreatePickersIfPresent(date);
            bindCreateSubmitIfPresent();
        }

        // âœ… create.html(ì‹ ê·œ í¼) ê¸°ì¤€: start/end + allDay + unscheduled
        function initCreatePickersIfPresent(dateParam) {
            const startDate = document.getElementById("startDateInput");
            const endDate   = document.getElementById("endDateInput");
            const startTime = document.getElementById("startTimeInput");
            const endTime   = document.getElementById("endTimeInput");

            const unscheduledToggle = document.getElementById("unscheduledToggle");
            const allDayToggle      = document.getElementById("allDayToggle");
            const scheduleFields    = document.getElementById("scheduleFields");
            const allDayRow         = document.getElementById("allDayRow");

            // create.htmlì´ êµ¬ë²„ì „(=dateInput/timeSelect)ì¼ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ì¡°ìš©íˆ ì¢…ë£Œ
            if (!startDate || !startTime || !unscheduledToggle || !allDayToggle || !scheduleFields) return;

            [startDate, endDate, startTime, endTime].forEach(el => {
                if (el && el._flatpickr) el._flatpickr.destroy();
            });

            flatpickr("#startDateInput", {
                dateFormat: "Y-m-d",
                defaultDate: dateParam ?? "today",
                locale: "ko"
            });

            if (endDate) {
                flatpickr("#endDateInput", {
                    dateFormat: "Y-m-d",
                    locale: "ko"
                });
            }

            flatpickr("#startTimeInput", {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                time_24hr: true,
                minuteIncrement: 30
            });

            if (endTime) {
                flatpickr("#endTimeInput", {
                    enableTime: true,
                    noCalendar: true,
                    dateFormat: "H:i",
                    time_24hr: true,
                    minuteIncrement: 30
                });
            }

            const applyState = () => {
                const isUnscheduled = !!unscheduledToggle.checked;
                const isAllDay = !!allDayToggle.checked;

                // ë¯¸ì •ì´ë©´ ìŠ¤ì¼€ì¤„ ë¹„í™œì„±í™” + ê°’ ì œê±°
                scheduleFields.style.opacity = isUnscheduled ? "0.5" : "1";
                [startDate, endDate, startTime, endTime].forEach(el => {
                    if (!el) return;
                    el.disabled = isUnscheduled;
                    if (isUnscheduled) el.value = "";
                });

                // ë¯¸ì •ì´ë©´ ì¢…ì¼ ê¸ˆì§€ (DTO ê·œì¹™)
                if (allDayRow) {
                    allDayRow.style.opacity = isUnscheduled ? "0.5" : "1";
                }
                allDayToggle.disabled = isUnscheduled;
                if (isUnscheduled) allDayToggle.checked = false;

                // ì¢…ì¼ì´ë©´ ì‹œê°„ ì…ë ¥ ê¸ˆì§€ (DTO ê·œì¹™: 00:00ë§Œ)
                const disableTime = (!isUnscheduled && isAllDay);
                if (startTime) {
                    startTime.disabled = isUnscheduled || disableTime;
                    if (disableTime) startTime.value = "";
                }
                if (endTime) {
                    endTime.disabled = isUnscheduled || disableTime;
                    if (disableTime) endTime.value = "";
                }
            };

            unscheduledToggle.addEventListener("change", applyState);
            allDayToggle.addEventListener("change", applyState);
            applyState();
        }

        function bindCreateSubmitIfPresent() {
            const submitBtn = document.getElementById("submitBtn");
            const form = document.getElementById("taskForm");
            const errorBox = document.getElementById("error-box");
            if (!submitBtn || !form || !errorBox) return;

            submitBtn.onclick = () => form.requestSubmit();

            form.onsubmit = async (e) => {
                e.preventDefault();
                errorBox.classList.add("hidden");

                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = "â³ ë“±ë¡ ì¤‘...";

                // ---- create.html(ì‹ ê·œ) ê¸°ì¤€ íŒŒì‹± ----
                const unscheduled = !!form.unscheduled?.checked;
                const allDay = !!form.allDay?.checked;

                const startDate = form.startDate?.value?.trim() || null;
                const startTime = form.startTime?.value?.trim() || null;
                const endDate   = form.endDate?.value?.trim() || null;
                const endTime   = form.endTime?.value?.trim() || null;

                let startAt = null;
                let endAt = null;
                let finalAllDay = allDay;

                if (unscheduled) {
                    startAt = null;
                    endAt = null;
                    finalAllDay = false; // DTO ê·œì¹™
                } else {
                    if (allDay) {
                        if (!startDate) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalText;
                            errorBox.innerText = "ì¢…ì¼ ì¼ì •ì€ ì‹œì‘ ë‚ ì§œê°€ í•„ìš”í•©ë‹ˆë‹¤.";
                            errorBox.classList.remove("hidden");
                            return;
                        }

                        startAt = toIsoLocalDateTime(startDate, "00:00");

                        // ì¢…ë£Œ ë‚ ì§œê°€ ìˆìœ¼ë©´ í¬í•¨ UX -> endExclusive(+1d 00:00)
                        if (endDate) {
                            const endExclusive = addDays(endDate, 1);
                            endAt = toIsoLocalDateTime(endExclusive, "00:00");
                        } else {
                            endAt = null;
                        }
                    } else {
                        // ì¼ë°˜ ì¼ì •: ì‹œì‘ ë‚ ì§œ/ì‹œê°„ í•„ìˆ˜
                        if (!startDate || !startTime) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalText;
                            errorBox.innerText = "ì¼ì •ì€ ì‹œì‘ ë‚ ì§œì™€ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ë˜ëŠ” ì¢…ì¼/ë¯¸ì • ì„ íƒ)";
                            errorBox.classList.remove("hidden");
                            return;
                        }

                        startAt = toIsoLocalDateTime(startDate, startTime);

                        // ì¢…ë£ŒëŠ” ì„ íƒì´ì§€ë§Œ, ì¢…ë£Œë¥¼ ì“°ë©´ ë‚ ì§œ/ì‹œê°„ ëª¨ë‘ í•„ìš”
                        if (endDate || endTime) {
                            if (!endDate || !endTime) {
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalText;
                                errorBox.innerText = "ì¢…ë£Œë¥¼ ì…ë ¥í•˜ë ¤ë©´ ì¢…ë£Œ ë‚ ì§œì™€ ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                                errorBox.classList.remove("hidden");
                                return;
                            }
                            endAt = toIsoLocalDateTime(endDate, endTime);
                        } else {
                            endAt = null;
                        }
                    }
                }

                const data = {
                    title: form.title?.value,
                    description: (form.description?.value || "").trim() || null,
                    startAt: startAt,
                    endAt: endAt,
                    category: (form.category?.value || "").trim() || null,
                    allDay: finalAllDay
                };

                let response;
                try {
                    response = await fetch("/api/tasks", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data)
                    });
                } catch (err) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    errorBox.innerText = "ì„œë²„ì™€ì˜ í†µì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                    errorBox.classList.remove("hidden");
                    return;
                }

                if (response.ok) {
                    submitBtn.innerHTML = "âœ” ë“±ë¡ ì™„ë£Œ";
                    showToast("ì¼ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    openModal();

                    form.reset();
                    AppModal.close();

                    setTimeout(() => window.location.reload(), 150);

                    setTimeout(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }, 500);
                } else {
                    const result = await response.json().catch(() => null);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;

                    errorBox.innerText = result?.message || "ë“±ë¡ ì‹¤íŒ¨";
                    errorBox.classList.remove("hidden");
                }
            };
        }

        function bindClose() {
            document.getElementById("appModalCloseBtn")?.addEventListener("click", close);
            document.getElementById("appModalBackdrop")?.addEventListener("click", (e) => {
                if (e.target?.id === "appModalBackdrop") close();
            });
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape" && !modal()?.classList.contains("hidden")) close();
            });
        }

        return { bindClose, loadCreate, close };
    })();

    // ìƒì„¸ ëª¨ë‹¬
    const DetailModal = (() => {
        const modal = () => document.getElementById("detailModal");
        const content = () => document.getElementById("detailModalContent");

        function open() {
            modal()?.classList.remove("hidden");
            document.body.style.overflow = "hidden";
        }

        function close() {
            modal()?.classList.add("hidden");
            document.body.style.overflow = "";
            if (content()) content().innerHTML = "";
        }

        async function loadDetail(taskId) {
            if (!taskId) return;

            const url = `/api/tasks/${encodeURIComponent(taskId)}`;
            content().innerHTML = "<div class='text-gray-400 text-sm'>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>";

            let res;
            try {
                res = await fetch(url, { headers: { "X-Requested-With": "fetch" }});
            } catch (e) {
                showToast("ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                return;
            }

            if (!res.ok) {
                showToast("ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                return;
            }

            const html = await res.text();
            content().innerHTML = html;
            open();
        }

        function bindClose() {
            document.getElementById("detailModalCloseBtn")?.addEventListener("click", close);
            document.getElementById("detailModalBackdrop")?.addEventListener("click", (e) => {
                if (e.target?.id === "detailModalBackdrop") close();
            });
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape" && !modal()?.classList.contains("hidden")) close();
            });
        }

        return { bindClose, loadDetail, close };
    })();

    // detail.htmlì—ì„œ í˜¸ì¶œ
    function closeTaskDetailModal() {
        DetailModal.close();
    }

    document.addEventListener("DOMContentLoaded", () => {
        AppModal.bindClose();
        DetailModal.bindClose();

        const createBtn = document.getElementById("floatingCreateBtn");
        createBtn?.addEventListener("click", async (e) => {
            e.preventDefault();
            const dayPage = document.getElementById("day-page");
            const date = dayPage?.dataset?.date || null;
            await AppModal.loadCreate(date);
        });

        // ìƒì„¸ ì—´ê¸°: data-task-id í´ë¦­
        document.addEventListener("click", async (e) => {
            const el = e.target?.closest?.("[data-task-id]");
            if (!el) return;

            const taskId = el.getAttribute("data-task-id");
            await DetailModal.loadDetail(taskId);
        });
    });
</script>

</body>
</html>

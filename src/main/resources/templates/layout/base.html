<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title th:text="${title}">ToDoLab</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <!-- flatpickr (create í˜ì´ì§€ì—ì„œë§Œ ì“°ì§€ë§Œ ê³µìš©ìœ¼ë¡œ ë‘¬ë„ ë¬´ë°©) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_green.css">
</head>

<body class="bg-[#F7F6F2] h-screen flex flex-col">

<!-- âœ… í—¤ë”ëŠ” ê³ ì •(ìŠ¤í¬ë¡¤ì— ë°€ë¦¬ì§€ ì•Šê²Œ shrink-0) -->
<header class="w-full py-6 text-center shrink-0">
    <h1 class="text-3xl font-bold" th:text="${headerTitle}">ToDoLab</h1>
</header>

<!-- âœ… mainë§Œ ìŠ¤í¬ë¡¤ë˜ë„ë¡ overflow-y-auto + footer ë†’ì´ë§Œí¼ padding-bottom -->
<main class="flex-1 w-full max-w-7xl mx-auto overflow-y-auto pb-28">
    <div th:utext="${body}"></div>
</main>

<!-- Floating + ë²„íŠ¼ -->
<a id="floatingCreateBtn"
   href="/tasks/create"
   class="fixed bottom-24 right-10 bg-blue-600 text-white w-14 h-14
          rounded-full flex items-center justify-center shadow-xl text-3xl z-50">
    +
</a>

<!-- âœ… í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜: í™”ë©´ì— ê³ ì • -->
<footer class="fixed bottom-0 inset-x-0 w-full bg-white py-4 border-t flex justify-around text-gray-500 text-sm z-40">
    <a href="/tasks/day"
       th:classappend="${activeTab == 'day'} ? ' font-semibold text-blue-600' : ''"
       class="hover:text-black">ì¼</a>
    <a href="/tasks/week"
       th:classappend="${activeTab == 'week'} ? ' font-semibold text-blue-600' : ''"
       class="hover:text-black">ì£¼</a>
    <a href="/tasks/month"
       th:classappend="${activeTab == 'month'} ? ' font-semibold text-blue-600' : ''"
       class="hover:text-black">ì›”</a>
</footer>

<!-- âœ… ê¸°ì¡´ ë“±ë¡ ê¸°ëŠ¥(ì„±ê³µ ëª¨ë‹¬/í† ìŠ¤íŠ¸) ê³µìš© ë°°ì¹˜ -->
<div id="successModal"
     class="fixed inset-0 hidden bg-black/40 flex items-center justify-center z-50">
    <div class="bg-white shadow-xl rounded-xl px-6 py-5 text-center animate-fade-in">
        <div class="text-4xl mb-2">ğŸ‰</div>
        <div class="text-lg font-bold mb-4">ì¼ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
        <button type="button" onclick="closeModal()"
                class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            í™•ì¸
        </button>
    </div>
</div>

<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-3"></div>

<style>
    @keyframes fade-in {
        from { opacity: 0; transform: scale(0.95); }
        to   { opacity: 1; transform: scale(1); }
    }
    .animate-fade-in { animation: fade-in 0.25s ease-out; }
</style>

<!-- flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>

<script>
    /* ---- ëª¨ë‹¬ ---- */
    function openModal() {
        document.getElementById("successModal")?.classList.remove("hidden");
    }
    function closeModal() {
        document.getElementById("successModal")?.classList.add("hidden");
    }

    /* ---- Toast ---- */
    function showToast(message) {
        const container = document.getElementById("toast-container");
        if (!container) return;

        const toast = document.createElement("div");
        toast.className =
            "bg-black text-white px-4 py-2 rounded shadow-lg opacity-90 transition transform text-sm";
        toast.innerHTML = "âœ”ï¸ " + message;

        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.add("opacity-0");
            setTimeout(() => toast.remove(), 300);
        }, 2000);
    }

    /* ------------------------------
       + ë²„íŠ¼: day í˜ì´ì§€ë©´ ë‚ ì§œ í¬í•¨í•´ì„œ create ì´ë™
       ------------------------------ */
    document.addEventListener("DOMContentLoaded", () => {
        const createBtn = document.getElementById("floatingCreateBtn");
        if (!createBtn) return;

        createBtn.addEventListener("click", (e) => {
            const dayPage = document.getElementById("day-page");
            const date = dayPage?.dataset?.date;

            if (date) {
                e.preventDefault();
                window.location.href = `/tasks/create?date=${date}`;
            }
        });
    });

    /* ------------------------------
       create í˜ì´ì§€ ì „ìš© submit ë¡œì§
       ------------------------------ */
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("taskForm");
        const btn = document.getElementById("submitBtn");
        const errorBox = document.getElementById("error-box");

        if (!form || !btn || !errorBox) return;

        const originalText = btn.innerHTML;

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            errorBox.classList.add("hidden");

            btn.disabled = true;
            btn.innerHTML = "â³ ë“±ë¡ ì¤‘...";

            const data = {
                title: form.title?.value,
                description: form.description?.value,
                date: form.date?.value,
                time: form.time?.value
            };

            let response;
            try {
                response = await fetch("/tasks", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
            } catch (err) {
                btn.disabled = false;
                btn.innerHTML = originalText;
                errorBox.innerText = "ì„œë²„ì™€ì˜ í†µì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                errorBox.classList.remove("hidden");
                return;
            }

            if (response.ok) {
                btn.innerHTML = "âœ” ë“±ë¡ ì™„ë£Œ";
                showToast("ì¼ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                openModal();
                form.reset();

                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }, 1000);
            } else {
                const result = await response.json().catch(() => null);
                btn.disabled = false;
                btn.innerHTML = originalText;

                errorBox.innerText = result?.message || "ë“±ë¡ ì‹¤íŒ¨";
                errorBox.classList.remove("hidden");
            }
        });
    });
</script>

</body>
</html>

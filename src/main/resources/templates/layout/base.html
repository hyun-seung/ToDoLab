<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title th:text="${title}">ToDoLab</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <!-- flatpickr (create í˜ì´ì§€ì—ì„œë§Œ ì“°ì§€ë§Œ ê³µìš©ìœ¼ë¡œ ë‘¬ë„ ë¬´ë°©) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_green.css">
</head>

<body class="bg-[#F7F6F2] h-screen flex flex-col">

<!-- âœ… í—¤ë”ëŠ” ê³ ì •(ìŠ¤í¬ë¡¤ì— ë°€ë¦¬ì§€ ì•Šê²Œ shrink-0) -->
<header class="w-full py-6 text-center shrink-0">
    <h1 class="text-3xl font-bold" th:text="${headerTitle}">ToDoLab</h1>
</header>

<!-- âœ… mainë§Œ ìŠ¤í¬ë¡¤ë˜ë„ë¡ overflow-y-auto + footer ë†’ì´ë§Œí¼ padding-bottom -->
<main class="flex-1 w-full max-w-7xl mx-auto overflow-y-auto pb-28">
    <div th:utext="${body}"></div>
</main>

<!-- Floating + ë²„íŠ¼ -->
<a id="floatingCreateBtn"
   href="/tasks/create"
   class="fixed bottom-24 right-10 bg-blue-600 text-white w-14 h-14
          rounded-full flex items-center justify-center shadow-xl text-3xl z-50">
    +
</a>

<!-- âœ… í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜: í™”ë©´ì— ê³ ì • -->
<footer class="fixed bottom-0 inset-x-0 w-full bg-white py-4 border-t flex justify-around text-gray-500 text-sm z-40">
    <a href="/tasks/day"
       th:classappend="${activeTab == 'day'} ? ' font-semibold text-blue-600' : ''"
       class="hover:text-black">ì¼</a>
    <a href="/tasks/week"
       th:classappend="${activeTab == 'week'} ? ' font-semibold text-blue-600' : ''"
       class="hover:text-black">ì£¼</a>
    <a href="/tasks/month"
       th:classappend="${activeTab == 'month'} ? ' font-semibold text-blue-600' : ''"
       class="hover:text-black">ì›”</a>
</footer>

<!-- âœ… ê¸°ì¡´ ë“±ë¡ ê¸°ëŠ¥(ì„±ê³µ ëª¨ë‹¬/í† ìŠ¤íŠ¸) ê³µìš© ë°°ì¹˜ -->
<div id="successModal"
     class="fixed inset-0 hidden bg-black/40 flex items-center justify-center z-50">
    <div class="bg-white shadow-xl rounded-xl px-6 py-5 text-center animate-fade-in">
        <div class="text-4xl mb-2">ğŸ‰</div>
        <div class="text-lg font-bold mb-4">ì¼ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
        <button type="button" onclick="closeModal()"
                class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            í™•ì¸
        </button>
    </div>
</div>

<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-3"></div>

<style>
    @keyframes fade-in {
        from { opacity: 0; transform: scale(0.95); }
        to   { opacity: 1; transform: scale(1); }
    }
    .animate-fade-in { animation: fade-in 0.25s ease-out; }
</style>

<!-- âœ… ì¼ì • ë“±ë¡(ëª¨ë‹¬) -->
<div id="appModal" class="fixed inset-0 hidden bg-black/40 z-50">
    <div id="appModalBackdrop" class="w-full h-full flex items-center justify-center p-4">

        <div id="appModalPanel"
             class="bg-white rounded-2xl shadow-2xl w-full max-w-lg
                    flex flex-col overflow-hidden">

            <!-- header -->
            <div class="flex items-center justify-between px-5 py-4 border-b shrink-0">
                <div class="font-bold text-gray-800">ì¼ì • ë“±ë¡</div>
                <button type="button" id="appModalCloseBtn"
                        class="text-gray-400 hover:text-gray-700 text-2xl leading-none">
                    Ã—
                </button>
            </div>

            <!-- âœ… body: flex-1 ì œê±° + í•„ìš”í•œ ê²½ìš°ì—ë§Œ ìŠ¤í¬ë¡¤ -->
            <div id="appModalContent"
                 class="p-5 overflow-y-auto max-h-[65vh]">
                <!-- create fragmentê°€ ì—¬ê¸°ë¡œ ì£¼ì…ë¨ -->
            </div>

            <!-- footer -->
            <div id="appModalFooter" class="shrink-0 border-t bg-white">
                <div class="p-4">
                    <button id="submitBtn" type="button"
                            class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">
                        ì¼ì • ë“±ë¡
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>

<script>
    /* ---- ì„±ê³µ ëª¨ë‹¬ ---- */
    function openModal() {
        document.getElementById("successModal")?.classList.remove("hidden");
    }
    function closeModal() {
        document.getElementById("successModal")?.classList.add("hidden");
    }

    /* ---- Toast ---- */
    function showToast(message) {
        const container = document.getElementById("toast-container");
        if (!container) return;

        const toast = document.createElement("div");
        toast.className =
            "bg-black text-white px-4 py-2 rounded shadow-lg opacity-90 transition transform text-sm";
        toast.innerHTML = "âœ”ï¸ " + message;

        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.add("opacity-0");
            setTimeout(() => toast.remove(), 300);
        }, 2000);
    }

    /* ==========================
       âœ… ì¶”ê°€: AppModal ì»¨íŠ¸ë¡¤
       ========================== */
    const AppModal = (() => {
        const modal = () => document.getElementById("appModal");
        const content = () => document.getElementById("appModalContent");

        function open() {
            modal()?.classList.remove("hidden");
            document.body.style.overflow = "hidden";
        }

        function close() {
            modal()?.classList.add("hidden");
            document.body.style.overflow = "";
            if (content()) content().innerHTML = "";
        }

        async function loadCreate(date) {
            // dateê°€ ìˆìœ¼ë©´ /tasks/create?date=... ì—†ìœ¼ë©´ /tasks/create
            const url = date ? `/tasks/create?date=${encodeURIComponent(date)}` : `/tasks/create`;

            // âœ… create.html(ë¶€ë¶„)ë§Œ ë°›ì•„ì˜¨ë‹¤ê³  ê°€ì • (ì§€ê¸ˆì€ íƒ€ì´í‹€ í¬ê²Œ ë³´ì´ëŠ” ê±´ ë¬´ì‹œí•œë‹¤ê³  í–ˆìœ¼ë‹ˆ,
            //    í˜¹ì‹œ layout/baseê°€ ë‚´ë ¤ì™€ë„ ì¼ë‹¨ ì£¼ì…ë˜ê¸´ í•©ë‹ˆë‹¤. ë²„íŠ¼ ë³´ì´ê²Œê°€ ìš°ì„ .)
            const res = await fetch(url, { headers: { "X-Requested-With": "fetch" }});
            const html = await res.text();

            content().innerHTML = html;
            open();

            // innerHTMLë¡œ ì£¼ì…ëœ scriptëŠ” ì‹¤í–‰ ì•ˆë¨ â†’ ì—¬ê¸°ì„œ ì§ì ‘ init
            initCreatePickersIfPresent(date);
            bindCreateSubmitIfPresent();
        }

        function initCreatePickersIfPresent(dateParam) {
            const dateInput = document.getElementById("dateInput");
            const timeSelect = document.getElementById("timeSelect");
            if (!dateInput || !timeSelect) return;

            // ê¸°ì¡´ ì¸í’‹ì— ì´ë¯¸ flatpickrê°€ ë¶™ì–´ìˆìœ¼ë©´ ì¤‘ë³µ ë°©ì§€
            if (dateInput._flatpickr) dateInput._flatpickr.destroy();
            if (timeSelect._flatpickr) timeSelect._flatpickr.destroy();

            flatpickr("#dateInput", {
                dateFormat: "Y-m-d",
                defaultDate: dateParam ?? "today",
                locale: "ko"
            });

            flatpickr("#timeSelect", {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                time_24hr: true,
                minuteIncrement: 30
            });
        }

        function bindCreateSubmitIfPresent() {
            const submitBtn = document.getElementById("submitBtn");
            const form = document.getElementById("taskForm");
            const errorBox = document.getElementById("error-box");

            if (!submitBtn || !form || !errorBox) return;

            // ë²„íŠ¼ í´ë¦­ â†’ submit
            submitBtn.onclick = () => form.requestSubmit();

            // submit ì´ë²¤íŠ¸ (ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€ ìœ„í•´ onsubmitë¡œ êµì²´)
            form.onsubmit = async (e) => {
                e.preventDefault();
                errorBox.classList.add("hidden");

                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = "â³ ë“±ë¡ ì¤‘...";

                const data = {
                    title: form.title?.value,
                    description: form.description?.value,
                    date: form.date?.value,
                    time: form.time?.value
                };

                let response;
                try {
                    response = await fetch("/tasks", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data)
                    });
                } catch (err) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    errorBox.innerText = "ì„œë²„ì™€ì˜ í†µì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                    errorBox.classList.remove("hidden");
                    return;
                }

                if (response.ok) {
                    submitBtn.innerHTML = "âœ” ë“±ë¡ ì™„ë£Œ";
                    showToast("ì¼ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    openModal();

                    form.reset();
                    AppModal.close();

                    // í™”ë©´ ê°±ì‹ (ë‹¹ì¥ ë¹ ë¥´ê²Œ)
                    setTimeout(() => window.location.reload(), 150);

                    setTimeout(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }, 500);
                } else {
                    const result = await response.json().catch(() => null);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;

                    errorBox.innerText = result?.message || "ë“±ë¡ ì‹¤íŒ¨";
                    errorBox.classList.remove("hidden");
                }
            };
        }

        function bindClose() {
            document.getElementById("appModalCloseBtn")?.addEventListener("click", close);
            document.getElementById("appModalBackdrop")?.addEventListener("click", (e) => {
                if (e.target?.id === "appModalBackdrop") close();
            });
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape" && !modal()?.classList.contains("hidden")) close();
            });
        }

        return { bindClose, loadCreate, close };
    })();

    /* ------------------------------
       âœ… ê¸°ì¡´ + ë²„íŠ¼ ë¡œì§ êµì²´: í˜ì´ì§€ ì´ë™ ëŒ€ì‹  ëª¨ë‹¬
       (ê¸°ë³¸ í˜ì´ì§€ëŠ” ê·¸ëŒ€ë¡œ, ëª¨ë‹¬ë§Œ ë„ì›€)
       ------------------------------ */
    document.addEventListener("DOMContentLoaded", () => {
        AppModal.bindClose();

        const createBtn = document.getElementById("floatingCreateBtn");
        if (!createBtn) return;

        createBtn.addEventListener("click", async (e) => {
            e.preventDefault();

            const dayPage = document.getElementById("day-page");
            const date = dayPage?.dataset?.date || null;

            await AppModal.loadCreate(date);
        });
    });
</script>

</body>
</html>

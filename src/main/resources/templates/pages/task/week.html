<!-- src/main/resources/templates/pages/task/week.html -->
<html lang="ko" xmlns:th="http://www.thymeleaf.org" th:inline="html">

<div class="px-5 py-6">

    <!-- 상단 헤더 -->
    <div class="flex items-center justify-between mb-4">

        <a th:href="'/tasks/week?move=prev&date=' + ${currentDate}"
           class="nav-btn"
           aria-label="지난주">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                 viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 19l-7-7 7-7" />
            </svg>
        </a>

        <div class="text-3xl font-bold text-gray-900">
            <span th:text="${currentDate.monthValue}">12</span>월
        </div>

        <a th:href="'/tasks/week?move=next&date=' + ${currentDate}"
           class="nav-btn"
           aria-label="다음주">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                 viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 5l7 7-7 7" />
            </svg>
        </a>
    </div>

    <!-- 주간 요일/날짜 스트립 -->
    <div class="rounded-2xl bg-white border border-gray-200 shadow-sm px-4 pt-3 pb-4">
        <div class="grid grid-cols-7 text-center text-sm text-gray-500 font-semibold mb-2">
            <div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div>
        </div>

        <div id="weekDayStrip" class="grid grid-cols-7 text-center">
            <a th:each="day : ${weeklyTasks}"
               th:href="'/tasks/day?date=' + ${day.date}"
               class="day-pill"
               th:attr="data-date=${day.date}, data-dow=${day.date.dayOfWeek.value}">
                <span class="day-label"
                      th:text="${day.date.dayOfMonth}">
                    17
                </span>
            </a>
        </div>
    </div>

    <!-- 선택된 날짜의 일정 -->
    <div class="mt-6 space-y-4">

        <div th:each="day : ${weeklyTasks}"
             class="task-card"
             th:attr="data-date=${day.date}">

            <div class="task-card-title">일정</div>

            <div th:if="${#lists.isEmpty(day.tasks)}"
                 class="p-5 text-sm text-gray-500">
                등록된 일정이 없습니다.
            </div>

            <div th:unless="${#lists.isEmpty(day.tasks)}"
                 class="divide-y divide-gray-100">

                <div th:each="t : ${day.tasks}"
                     th:attr="data-task-id=${t.id}"
                     class="task-row week-row">

                    <!-- 색상 바 -->
                    <div class="task-left-bar" style="background: [[${t.color}]]"></div>

                    <!-- 체크 -->
                    <div class="check-box">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                             viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M5 13l4 4L19 7" />
                        </svg>
                    </div>

                    <!-- 좌측: 제목 / 설명 -->
                    <div class="week-left min-w-0">
                        <div class="week-title" th:text="${t.title}">
                            제목
                        </div>

                        <div th:if="${t.description != null and !#strings.isEmpty(t.description)}"
                             class="week-sub"
                             th:text="${t.description}">
                            설명
                        </div>
                    </div>

                    <!-- 우측: 날짜 / 시간 -->
                    <div class="week-right">
                        <div class="week-date">
                            <span th:text="${day.date.monthValue}">1</span>월
                            <span th:text="${day.date.dayOfMonth}">22</span>
                        </div>
                        <div class="week-time"
                             th:text="${t.time != null ? t.time : '종일'}">
                            종일
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* 요일 스트립 */
    .day-pill{
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 9999px;
        transition: background .15s ease;
    }
    .day-pill:hover{ background: rgba(17,24,39,0.04); }

    .day-label{
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #111827;
        border-radius: 9999px;
        line-height: 1;
    }
    .day-label.is-focus{
        background: #6366f1;
        color: #fff;
        font-weight: 800;
        transform: translateY(-1px);
        box-shadow: 0 10px 18px rgba(99,102,241,0.20);
    }

    /* 주간 row */
    .week-row{
        cursor: pointer;
        padding-right: 8px;               /* ✅ row 자체 여유 */
        transition: background .15s ease;
    }
    .week-row:hover{
        background: rgba(17,24,39,0.02);
    }

    .week-left{
        display: flex;
        flex-direction: column;
        gap: 2px;
        flex: 1 1 auto;
    }
    .week-title{
        font-weight: 800;
        color: #1f2937;
        font-size: 18px;
        line-height: 1.2;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .week-sub{
        font-size: 13px;
        color: #6b7280;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* ✅ 핵심: 우측 여유 */
    .week-right{
        margin-left: 12px;
        min-width: 88px;                  /* 기존보다 넉넉 */
        padding-right: 10px;              /* 체감 여유 핵심 */
        text-align: right;
        display: flex;
        flex-direction: column;
        gap: 2px;
        justify-content: center;
        flex: 0 0 auto;
    }
    .week-date{
        font-size: 12px;
        color: #9ca3af;
        font-weight: 700;
        white-space: nowrap;
    }
    .week-time{
        font-size: 12px;
        color: #6b7280;
        font-weight: 700;
        white-space: nowrap;
    }

    /* 모바일 */
    @media (max-width: 640px){
        .week-title{ font-size: 16px; }
        .week-right{
            min-width: 76px;
            padding-right: 8px;
        }
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const strip = document.getElementById("weekDayStrip");
        const cards = Array.from(document.querySelectorAll(".task-card[data-date]"));
        if (!strip || !cards.length) return;

        const items = Array.from(strip.querySelectorAll("a[data-date][data-dow]"));
        if (!items.length) return;

        const clearFocus = () => {
            strip.querySelectorAll(".day-label.is-focus")
                 .forEach(el => el.classList.remove("is-focus"));
        };

        const showOnlyDate = (isoDate) => {
            cards.forEach(card => {
                card.style.display =
                    card.getAttribute("data-date") === isoDate ? "" : "none";
            });
        };

        const setFocusByItem = (item) => {
            if (!item) return;
            clearFocus();
            const label = item.querySelector(".day-label");
            label?.classList.add("is-focus");

            const iso = item.getAttribute("data-date");
            showOnlyDate(iso);
        };

        items.forEach(a => {
            a.addEventListener("click", (e) => {
                e.preventDefault();
                setFocusByItem(a);
            });
        });

        const todayIso = new Date().toISOString().slice(0, 10);
        const jsDow = new Date().getDay();        // 0..6 (일..토)
        const serverDow = jsDow === 0 ? 7 : jsDow;

        const todayItem = items.find(a => a.getAttribute("data-date") === todayIso);
        const dowItem = items.find(a => Number(a.getAttribute("data-dow")) === serverDow);

        setFocusByItem(todayItem || dowItem || items[0]);
    });
</script>

</html>

<!-- src/main/resources/templates/pages/task/week.html -->
<div th:fragment="content"
     id="week-page"
     class="px-4 pb-24 max-w-3xl mx-auto"
     th:attr="data-current-date=${currentDate},
              data-selected-date=${selectedDate}">

    <!-- ÏÉÅÎã® Ìó§Îçî -->
    <div class="relative mt-4">
        <a id="weekPrevBtn"
           th:href="'/tasks/week?move=prev&date=' + ${currentDate}"
           class="w-10 h-10 flex items-center justify-center rounded-2xl bg-white border border-gray-200
              shadow-[0_10px_24px_rgba(17,24,39,0.06)]
              font-black text-gray-900 select-none transition active:scale-[0.98] hover:bg-gray-50
              absolute left-0 top-1/2 -translate-y-1/2"
           aria-label="ÏßÄÎÇúÏ£º">‚Üê</a>

        <a id="weekNextBtn"
           th:href="'/tasks/week?move=next&date=' + ${currentDate}"
           class="w-10 h-10 flex items-center justify-center rounded-2xl bg-white border border-gray-200
              shadow-[0_10px_24px_rgba(17,24,39,0.06)]
              font-black text-gray-900 select-none transition active:scale-[0.98] hover:bg-gray-50
              absolute right-0 top-1/2 -translate-y-1/2"
           aria-label="Îã§ÏùåÏ£º">‚Üí</a>

        <div class="flex flex-col items-center text-center px-14">
            <div class="text-sm font-semibold text-gray-800">Ï£ºÍ∞Ñ ÏùºÏ†ï</div>
            <div id="weekRangeText"
                 class="mt-2 text-[12px] text-gray-400 font-semibold"
                 th:text="${weekRange}">2026-01-25 ~ 2026-01-31</div>
        </div>
    </div>

    <!-- ÏöîÏùº/ÎÇ†Ïßú -->
    <div class="mt-6">
        <!-- ‚úÖ ÏöîÏùºÎèÑ ÌÅ¥Î¶≠ Í∞ÄÎä•(Ïùº~ÌÜ†) -->
        <div id="weekDow"
             class="grid grid-cols-7 text-center text-[11px] font-semibold text-gray-500">
            <button type="button" class="text-red-500 select-none py-1" data-idx="0">Ïùº</button>
            <button type="button" class="select-none py-1" data-idx="1">Ïõî</button>
            <button type="button" class="select-none py-1" data-idx="2">Ìôî</button>
            <button type="button" class="select-none py-1" data-idx="3">Ïàò</button>
            <button type="button" class="select-none py-1" data-idx="4">Î™©</button>
            <button type="button" class="select-none py-1" data-idx="5">Í∏à</button>
            <button type="button" class="text-blue-500 select-none py-1" data-idx="6">ÌÜ†</button>
        </div>

        <div id="weekStrip"
             class="mt-1.5 grid grid-cols-7 text-center"
             th:with="today=${T(java.time.LocalDate).now()}">

            <!-- ‚úÖ Î∞±ÏóîÎìú weeklyTasksÍ∞Ä "Ïùº~ÌÜ†" ÏàúÏÑúÎ°ú ÎÇ¥Î†§Ïò®Îã§Í≥† Í∞ÄÏ†ï -->
            <a th:each="day : ${weeklyTasks}"
               href="#"
               th:attr="data-date=${day.date},
                        data-has=${#lists.isEmpty(day.tasks) ? '0' : '1'}"
               class="group flex flex-col items-center justify-center py-[2px] rounded-lg select-none cursor-pointer
                transition hover:bg-black/[0.03] active:scale-[0.99] active:bg-black/[0.045]
                focus:outline-none focus-visible:ring-4 focus-visible:ring-indigo-500/20">

                <div class="relative w-9 h-9 rounded-full flex items-center justify-center transition"
                     th:classappend="${day.date.equals(selectedDate)} ? ' bg-indigo-500 shadow-[0_10px_18px_rgba(99,102,241,0.20)] -translate-y-[1px]' : ''">

                    <span th:if="${day.date.equals(today)}"
                          class="absolute -inset-[2px] rounded-full border-2 border-indigo-500/55 pointer-events-none"
                          th:classappend="${day.date.equals(selectedDate)} ? ' border-white/85' : ''"></span>

                    <span class="text-[14px] font-black leading-none text-gray-900"
                          th:classappend="${day.date.equals(selectedDate)} ? ' text-white' : ''"
                          th:text="${day.date.dayOfMonth}">30</span>
                </div>

                <!-- dot -->
                <div class="mt-1 w-1.5 h-1.5 rounded-full bg-indigo-500/70 transition"
                     th:classappend="${#lists.isEmpty(day.tasks)} ? ' opacity-0' : ' opacity-100'"></div>
            </a>
        </div>
    </div>

    <!-- ÎÇ†ÏßúÎ≥Ñ ÏùºÏ†ï -->
    <div id="weekDays" class="mt-8 space-y-3">

        <div th:each="day : ${weeklyTasks}"
             class="week-day"
             th:attr="data-date=${day.date}"
             th:classappend="${day.date.equals(selectedDate)} ? '' : ' hidden'">

            <!-- ‚úÖ ÏùºÏ†ï ÏóÜÏùå(ÌÅ¨Í∏∞ Ï§ÑÏûÑ) -->
            <div th:if="${#lists.isEmpty(day.tasks)}" class="flex justify-center mt-8">
                <div class="w-full border border-dashed border-gray-300 rounded-[22px] p-10 text-center bg-white/35">
                    <div class="text-2xl">üì≠</div>
                    <div class="mt-3 text-xl font-extrabold text-gray-800">Îì±Î°ùÎêú ÏùºÏ†ïÏù¥ ÏóÜÏñ¥Ïöî</div>
                    <div class="mt-1 text-sm text-gray-500 font-semibold">ÌïÑÏöîÌïú ÏùºÎ∂ÄÌÑ∞ ÌïòÎÇòÏî© Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî</div>
                </div>
            </div>

            <!-- ‚úÖ ÏùºÏ†ï Î¶¨Ïä§Ìä∏ -->
            <div th:unless="${#lists.isEmpty(day.tasks)}" class="space-y-3">
                <div th:each="t : ${day.tasks}"
                     class="bg-white border border-gray-200 rounded-2xl
                    shadow-[0_10px_24px_rgba(17,24,39,0.06)]
                    cursor-pointer hover:bg-gray-50 active:scale-[0.995]"
                     th:attr="data-task-id=${t.id}">

                    <div class="flex items-center gap-3 px-4 py-4">
                        <div class="w-1.5 h-11 rounded-full flex-none bg-indigo-500/85 opacity-65"></div>
                        <div class="w-7 h-7 rounded-xl bg-gray-100 text-gray-500 flex items-center justify-center font-black select-none flex-none">‚úì</div>

                        <div class="min-w-0 flex-1">
                            <div class="flex items-center gap-2">
                                <div class="text-[16px] font-black text-gray-900 truncate" th:text="${t.title}">Ï†úÎ™©</div>
                                <span th:if="${t.category != null and !#strings.isEmpty(t.category)}"
                                      class="text-[11px] px-2 py-1 rounded-full bg-gray-100 text-gray-700"
                                      th:text="${t.category}"></span>
                            </div>

                            <div th:if="${t.description != null and !#strings.isEmpty(t.description)}"
                                 class="mt-1 text-[13px] text-gray-500 font-semibold line-clamp-2"
                                 th:text="${t.description}">ÏÑ§Î™Ö</div>
                        </div>

                        <div class="text-[12px] text-gray-500 font-extrabold whitespace-nowrap ml-2 flex-none"
                             th:text="${t.allDay} ? 'Ï¢ÖÏùº' : (${t.time} != null ? ${#temporals.format(t.time,'HH:mm')} : '')">
                            Ï¢ÖÏùº
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚úÖ Ï§ëÏöî: scriptÎ•º fragment ÎÇ¥Î∂ÄÏóê Îë¨Ïïº th:replaceÎ°ú Ìè¨Ìï®Îê† ÎïåÎèÑ Ïã§ÌñâÎê® -->
    <script>
        (() => {
          const root = document.getElementById("week-page");
          if (!root) return;

          // ‚úÖ Ï§ëÎ≥µ Î∞îÏù∏Îî© Î∞©ÏßÄ
          if (root.dataset.bound === "1") return;
          root.dataset.bound = "1";

          const rangeEl = document.getElementById("weekRangeText");
          const stripEl = document.getElementById("weekStrip");
          const daysEl  = document.getElementById("weekDays");
          const prevBtn = document.getElementById("weekPrevBtn");
          const nextBtn = document.getElementById("weekNextBtn");
          const dowEl   = document.getElementById("weekDow");

          // ‚úÖ strip/dowÍ∞Ä ÏóÜÏúºÎ©¥ Î∞îÏù∏Îî© ÏûêÏ≤¥Í∞Ä Ïïà ÎêòÎØÄÎ°ú Î∞©Ïñ¥ (ÏΩòÏÜî ÏóêÎü¨ Î∞©ÏßÄ)
          if (!stripEl || !daysEl) return;

          // ===== date util (YYYY-MM-DD) =====
          const pad2 = (n) => String(n).padStart(2, "0");
          const parseISO = (iso) => {
            const [y,m,d] = iso.split("-").map(Number);
            return new Date(y, m-1, d);
          };
          const toISO = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
          const addDays = (iso, n) => {
            const d = parseISO(iso);
            d.setDate(d.getDate() + n);
            return toISO(d);
          };

          const weekStartISO = (anyISO) => {
            const d = parseISO(anyISO);
            const dow = d.getDay(); // 0=Ïùº..6=ÌÜ†
            d.setDate(d.getDate() - dow);
            return toISO(d);
          };
          const weekRangeText = (anyISO) => {
            const start = weekStartISO(anyISO);
            const end = addDays(start, 6);
            return `${start} ~ ${end}`;
          };

          // ===== state =====
          let selectedISO = root.getAttribute("data-selected-date");
          let currentISO  = root.getAttribute("data-current-date");
          const todayISO = toISO(new Date());

          function setSelected(iso) {
            if (!iso) return;

            selectedISO = iso;
            root.setAttribute("data-selected-date", iso);

            // 1) ÏïÑÎûò ÏùºÏ†ï ÌÜ†Í∏Ä
            daysEl.querySelectorAll(".week-day[data-date]").forEach(box => {
              box.classList.toggle("hidden", box.getAttribute("data-date") !== iso);
            });

            // 2) strip Ïõê/ÌÖçÏä§Ìä∏/Ïò§ÎäòÎßÅ ÌÜ†Í∏Ä
            stripEl.querySelectorAll("a[data-date]").forEach(a => {
              const d = a.getAttribute("data-date");
              const isSel = (d === iso);

              const circle = a.querySelector("div.relative");
              if (!circle) return;

              const ring = circle.querySelector("span.absolute");
              const num  = circle.querySelector("span:not(.absolute)");

              circle.classList.toggle("bg-indigo-500", isSel);
              circle.classList.toggle("shadow-[0_10px_18px_rgba(99,102,241,0.20)]", isSel);
              circle.classList.toggle("-translate-y-[1px]", isSel);

              if (num) {
                if (isSel) {
                  num.classList.add("text-white");
                  num.classList.remove("text-gray-900");
                } else {
                  num.classList.remove("text-white");
                  num.classList.add("text-gray-900");
                }
              }

              if (ring) {
                if (isSel) {
                  ring.classList.add("border-white/85");
                  ring.classList.remove("border-indigo-500/55");
                } else {
                  ring.classList.remove("border-white/85");
                  ring.classList.add("border-indigo-500/55");
                }
              }
            });
          }

          function updateNavHrefs(cur){
            if (!prevBtn || !nextBtn) return;

            const prev = new URL(prevBtn.getAttribute("href"), location.origin);
            const next = new URL(nextBtn.getAttribute("href"), location.origin);

            prev.searchParams.set("date", cur);
            next.searchParams.set("date", cur);

            prevBtn.setAttribute("href", prev.pathname + "?" + prev.searchParams.toString());
            nextBtn.setAttribute("href", next.pathname + "?" + next.searchParams.toString());
          }

          function renderLoadingState() {
            daysEl.innerHTML = `
              <div class="flex justify-center mt-8">
                <div class="w-full border border-dashed border-gray-300 rounded-[22px] p-10 text-center bg-white/35">
                  <div class="text-2xl">‚è≥</div>
                  <div class="mt-3 text-xl font-extrabold text-gray-800">Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
                  <div class="mt-1 text-sm text-gray-500 font-semibold">Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî</div>
                </div>
              </div>
            `;
          }

          function renderOptimisticWeek(curISO, selISO) {
            currentISO = curISO;
            selectedISO = selISO;

            root.setAttribute("data-current-date", curISO);
            root.setAttribute("data-selected-date", selISO);

            if (rangeEl) rangeEl.textContent = weekRangeText(curISO);

            const start = weekStartISO(curISO);

            stripEl.innerHTML = "";
            for (let i=0; i<7; i++) {
              const iso = addDays(start, i);
              const dayNum = parseISO(iso).getDate();
              const isSel = (iso === selISO);
              const isToday = (iso === todayISO);

              const a = document.createElement("a");
              a.href = "#";
              a.setAttribute("data-date", iso);
              a.setAttribute("data-has", "0");

              a.className =
                "group flex flex-col items-center justify-center py-[2px] rounded-lg select-none cursor-pointer " +
                "transition hover:bg-black/[0.03] active:scale-[0.99] active:bg-black/[0.045] " +
                "focus:outline-none focus-visible:ring-4 focus-visible:ring-indigo-500/20";

              a.innerHTML = `
                <div class="relative w-9 h-9 rounded-full flex items-center justify-center transition
                            ${isSel ? "bg-indigo-500 shadow-[0_10px_18px_rgba(99,102,241,0.20)] -translate-y-[1px]" : ""}">
                  ${
                    isToday
                      ? `<span class="absolute -inset-[2px] rounded-full border-2 ${isSel ? "border-white/85" : "border-indigo-500/55"} pointer-events-none"></span>`
                      : ""
                  }
                  <span class="text-[14px] font-black leading-none ${isSel ? "text-white" : "text-gray-900"}">${dayNum}</span>
                </div>
                <div class="mt-1 w-1.5 h-1.5 rounded-full bg-indigo-500/70 opacity-0"></div>
              `;

              stripEl.appendChild(a);
            }

            updateNavHrefs(curISO);
            renderLoadingState();
            setSelected(selISO);
          }

          let reqSeq = 0;

          async function fetchAndCommit(href) {
            const mySeq = ++reqSeq;

            try {
              const res = await fetch(href, { headers: { "X-Requested-With": "fetch" } });
              if (!res.ok) throw new Error("HTTP " + res.status);
              const html = await res.text();
              if (mySeq !== reqSeq) return;

              const doc = new DOMParser().parseFromString(html, "text/html");
              const newRoot = doc.getElementById("week-page");
              if (!newRoot) return;

              const newRange = newRoot.querySelector("#weekRangeText");
              const newStrip = newRoot.querySelector("#weekStrip");
              const newDays  = newRoot.querySelector("#weekDays");

              if (newRange && rangeEl) rangeEl.textContent = newRange.textContent || "";
              if (newStrip) stripEl.innerHTML = newStrip.innerHTML;
              if (newDays)  daysEl.innerHTML  = newDays.innerHTML;

              const cd = newRoot.getAttribute("data-current-date");
              if (cd) {
                currentISO = cd;
                root.setAttribute("data-current-date", cd);
              }

              updateNavHrefs(currentISO);

              const exists = !!stripEl.querySelector(`a[data-date="${CSS.escape(selectedISO)}"]`);
              if (!exists) {
                const first = stripEl.querySelector("a[data-date]");
                selectedISO = first ? first.getAttribute("data-date") : selectedISO;
              }
              setSelected(selectedISO);

            } catch (e) {
              if (mySeq !== reqSeq) return;
              daysEl.innerHTML = `
                <div class="flex justify-center mt-8">
                  <div class="w-full border border-dashed border-gray-300 rounded-[22px] p-10 text-center bg-white/35">
                    <div class="text-2xl">‚ö†Ô∏è</div>
                    <div class="mt-3 text-xl font-extrabold text-gray-800">Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏñ¥Ïöî</div>
                    <div class="mt-1 text-sm text-gray-500 font-semibold">Îã§Ïãú ÏãúÎèÑÌï¥Î≥¥ÏÑ∏Ïöî</div>
                  </div>
                </div>
              `;
              console.warn("[week] fetch failed:", e);
            }
          }

          // ‚úÖ ÎÇ†Ïßú(Ïõê) ÌÅ¥Î¶≠
          stripEl.addEventListener("click", (e) => {
            const a = e.target.closest("a[data-date]");
            if (!a) return;
            e.preventDefault();
            setSelected(a.getAttribute("data-date"));
          });

          // ‚úÖ ÏöîÏùº ÌÅ¥Î¶≠
          if (dowEl) {
            dowEl.addEventListener("click", (e) => {
              const btn = e.target.closest("button[data-idx]");
              if (!btn) return;

              const idx = Number(btn.getAttribute("data-idx"));
              const items = Array.from(stripEl.querySelectorAll("a[data-date]"));
              const target = items[idx];
              if (!target) return;

              setSelected(target.getAttribute("data-date"));
            });
          }

          function bindNav(btn, deltaDays){
            if (!btn) return;

            btn.onclick = (e) => {
              e.preventDefault();

              const cur = root.getAttribute("data-current-date") || currentISO;
              const nextCur = addDays(cur, deltaDays);
              const nextSel = addDays(selectedISO, deltaDays);

              renderOptimisticWeek(nextCur, nextSel);

              const href = btn.getAttribute("href");
              if (href) history.pushState({ href }, "", href);
              if (href) fetchAndCommit(href);
            };
          }

          updateNavHrefs(currentISO);

          if (!selectedISO) {
            const first = stripEl.querySelector("a[data-date]");
            selectedISO = first ? first.getAttribute("data-date") : selectedISO;
          }
          setSelected(selectedISO);

          bindNav(prevBtn, -7);
          bindNav(nextBtn, +7);

          window.addEventListener("popstate", () => {
            const href = location.pathname + location.search;
            renderLoadingState();
            fetchAndCommit(href);
          });
        })();
    </script>

</div>

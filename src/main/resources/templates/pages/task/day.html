<!-- src/main/resources/templates/pages/task/day.html -->
<div th:fragment="content">

    <style>
        /* ===== Í≥µÌÜµ(Ïπ¥Îìú/Î≤ÑÌäº) : day Í∏∞Ï§Ä ===== */
        .nav-btn{
          width:44px;height:44px;
          display:flex;align-items:center;justify-content:center;
          border-radius:14px;background:#fff;
          border:1px solid rgba(229,231,235,1);
          box-shadow:0 10px 24px rgba(17,24,39,0.06);
          font-weight:900;color:#111827;
          user-select:none;
          transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
        }
        .nav-btn:hover{ background:rgba(17,24,39,0.02); }
        .nav-btn:active{ transform:scale(0.98); box-shadow:0 6px 16px rgba(17,24,39,0.06); }

        .today-badge{
          display:inline-flex;align-items:center;justify-content:center;
          padding:6px 12px;border-radius:9999px;
          background:rgba(99,102,241,0.12);
          color:rgba(67,56,202,1);
          font-size:12px;font-weight:900;letter-spacing:.06em;
          border:1px solid rgba(99,102,241,0.25);
          user-select:none;
        }

        .task-card{
          background:#fff;
          border:1px solid rgba(229,231,235,1);
          border-radius:18px;
          box-shadow:0 14px 28px rgba(17,24,39,0.06);
        }
        .task-row{ display:flex; align-items:center; gap:12px; padding:14px 14px; }
        .task-left-bar{
          width:6px;height:44px;border-radius:9999px;flex:0 0 auto;opacity:.65;
        }
        .check-box{
          width:26px;height:26px;border-radius:10px;
          background:rgba(243,244,246,1);
          color:rgba(107,114,128,1);
          display:flex;align-items:center;justify-content:center;
          font-weight:900;flex:0 0 auto;user-select:none;
        }
        .task-title{ font-size:16px;font-weight:900;color:#111827; }
        .task-desc{ font-size:13px;color:#6b7280;font-weight:600; }
        .task-date{
          font-size:12px;color:#6b7280;font-weight:800;
          white-space:nowrap;margin-left:10px;flex:0 0 auto;
        }
    </style>

    <div id="day-page"
         class="px-4 pb-24 max-w-3xl mx-auto"
         th:attr="data-date=${date}">

        <!-- ÏÉÅÎã® ÎÑ§ÎπÑ -->
        <div class="relative mt-4 mb-8">
            <!-- Ïù¥Ï†Ñ -->
            <a id="dayPrevBtn"
               th:href="'/tasks/day?move=prev&date=' + ${date}"
               class="nav-btn absolute left-0 top-1/2 -translate-y-1/2"
               aria-label="Ïù¥Ï†Ñ ÎÇ†">‚Üê</a>

            <!-- Ï§ëÏïô ÎÇ†Ïßú -->
            <div class="flex flex-col items-center">
                <div id="dayDateText"
                     class="text-sm font-semibold text-gray-800"
                     th:text="${date}">2026-01-30</div>

                <div class="mt-2">
          <span id="dayTodayBadge"
                class="today-badge"
                th:classappend="${isToday} ? '' : ' hidden'">TODAY</span>
                </div>

                <div class="mt-2 text-[12px] text-gray-400 font-semibold">
                    ÏùºÍ∞Ñ ÏùºÏ†ï
                </div>
            </div>

            <!-- Îã§Ïùå -->
            <a id="dayNextBtn"
               th:href="'/tasks/day?move=next&date=' + ${date}"
               class="nav-btn absolute right-0 top-1/2 -translate-y-1/2"
               aria-label="Îã§Ïùå ÎÇ†">‚Üí</a>
        </div>

        <div id="day-loading" class="hidden"></div>
        <div id="day-error" class="mt-8 text-red-600 text-sm hidden"></div>

        <div id="day-empty"
             class="hidden mt-20 flex flex-col items-center justify-center text-center select-none">
            <div class="w-14 h-14 rounded-2xl bg-white/60 border border-gray-200
                  flex items-center justify-center shadow-sm">
                <span class="text-2xl">üóìÔ∏è</span>
            </div>
            <div class="mt-5 text-2xl font-extrabold text-gray-800">Îì±Î°ùÎêú ÏùºÏ†ïÏù¥ ÏóÜÏñ¥Ïöî</div>
            <div class="mt-3 text-base text-gray-500 font-semibold">Ïò§Îäò Ìï¥Ïïº Ìï† ÏùºÎ∂ÄÌÑ∞ Ï∞®Î∂ÑÌûà Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî</div>
        </div>

        <div id="day-list" class="mt-10 space-y-3"></div>
    </div>

    <script>
        (() => {
          const root = document.getElementById('day-page');
          if (!root) return;

          const $dateText = document.getElementById('dayDateText');
          const $todayBadge = document.getElementById('dayTodayBadge');

          const $error = document.getElementById('day-error');
          const $empty = document.getElementById('day-empty');
          const $list = document.getElementById('day-list');

          const $prev = document.getElementById('dayPrevBtn');
          const $next = document.getElementById('dayNextBtn');

          let currentDate = root.dataset.date;

          let inflightAbort = null;
          let requestSeq = 0;
          let navigating = false;

          const cache = new Map();

          function hideAllState() {
            $error.classList.add('hidden');
            $empty.classList.add('hidden');
          }

          function showError(msg) {
            hideAllState();
            $list.innerHTML = '';
            $error.textContent = msg;
            $error.classList.remove('hidden');
          }

          function showEmpty() {
            hideAllState();
            $list.innerHTML = '';
            $empty.classList.remove('hidden');
          }

          function showList(html) {
            hideAllState();
            $empty.classList.add('hidden');
            $list.innerHTML = html;
          }

          function escapeHtml(s) {
            return String(s ?? '')
              .replaceAll('&', '&amp;')
              .replaceAll('<', '&lt;')
              .replaceAll('>', '&gt;')
              .replaceAll('"', '&quot;')
              .replaceAll("'", '&#039;');
          }

          function toLocalDatePart(isoLocalDateTime) {
            if (!isoLocalDateTime) return null;
            return isoLocalDateTime.split('T')[0];
          }

          function toLocalTimePartHM(isoLocalDateTime) {
            if (!isoLocalDateTime) return null;
            const t = isoLocalDateTime.split('T')[1] || '';
            return t.substring(0, 5);
          }

          function compareDateStr(a, b) {
            if (a === b) return 0;
            return a < b ? -1 : 1;
          }

          function occursOn(task, targetDate) {
            if (task.unscheduled) return false;

            const s = task.startAt;
            const e = task.endAt;
            if (!s && !e) return false;

            const sd = s ? toLocalDatePart(s) : null;
            const ed = e ? toLocalDatePart(e) : null;

            const endDate = ed ?? sd;
            const startDate = sd ?? endDate;
            if (!startDate || !endDate) return false;

            return compareDateStr(startDate, targetDate) <= 0 &&
                   compareDateStr(endDate, targetDate) >= 0;
          }

          function buildTimeText(task, targetDate) {
            if (task.allDay) return 'Ï¢ÖÏùº';

            const s = task.startAt;
            const e = task.endAt;
            if (!s && !e) return '';

            const sd = s ? toLocalDatePart(s) : null;
            const ed = e ? toLocalDatePart(e) : null;
            const st = s ? toLocalTimePartHM(s) : null;
            const et = e ? toLocalTimePartHM(e) : null;

            if (sd && ed && sd === targetDate && ed === targetDate) {
              if (st && et) return `${st} ~ ${et}`;
              if (st) return `${st}`;
              return '';
            }

            if (sd === targetDate && st) return `${st} ~ ‚Ä¶`;
            if (ed === targetDate && et) return `‚Ä¶ ~ ${et}`;
            return 'Í≥ÑÏÜç';
          }

          function sortTasks(tasks, targetDate) {
            function groupKey(t) {
              if (t.allDay) return 1;
              const sd = t.startAt ? toLocalDatePart(t.startAt) : null;
              const ed = t.endAt ? toLocalDatePart(t.endAt) : null;
              if (sd === targetDate && ed === targetDate) return 0;
              return 2;
            }
            function timeKey(t) {
              const st = t.startAt ? toLocalTimePartHM(t.startAt) : null;
              return st ?? '99:99';
            }

            return [...tasks].sort((a, b) => {
              const ga = groupKey(a), gb = groupKey(b);
              if (ga !== gb) return ga - gb;

              if (ga === 0) {
                const ta = timeKey(a), tb = timeKey(b);
                if (ta !== tb) return ta < tb ? -1 : 1;
              }

              const at = (a.title ?? '').toLowerCase();
              const bt = (b.title ?? '').toLowerCase();
              return at.localeCompare(bt);
            });
          }

          function badgeCategory(cat) {
            if (!cat) return '';
            const safe = escapeHtml(cat);
            return `<span class="text-[11px] px-2 py-1 rounded-full bg-gray-100 text-gray-700">${safe}</span>`;
          }

          function updateHeader(dateStr) {
            root.dataset.date = dateStr;
            $dateText.textContent = dateStr;

            const todayIso = new Date().toISOString().slice(0, 10);
            if ($todayBadge) {
              if (todayIso === dateStr) $todayBadge.classList.remove('hidden');
              else $todayBadge.classList.add('hidden');
            }

            $prev.href = `/tasks/day?move=prev&date=${encodeURIComponent(dateStr)}`;
            $next.href = `/tasks/day?move=next&date=${encodeURIComponent(dateStr)}`;
          }

          function buildCardsHtml(tasks, targetDate) {
            return tasks.map(t => {
              const title = escapeHtml(t.title);
              const desc = escapeHtml(t.description);
              const timeText = escapeHtml(buildTimeText(t, targetDate));
              const categoryHtml = badgeCategory(t.category);

              return `
                <div class="task-card cursor-pointer hover:bg-gray-50 active:scale-[0.995]"
                     data-task-id="${t.id}">
                  <div class="task-row">
                    <div class="task-left-bar" style="background: rgba(99, 102, 241, 0.55);"></div>
                    <div class="check-box">‚úì</div>

                    <div class="min-w-0 flex-1">
                      <div class="flex items-center gap-2">
                        <div class="task-title truncate">${title}</div>
                        ${categoryHtml}
                      </div>
                      ${desc ? `<div class="task-desc mt-1 line-clamp-2">${desc}</div>` : ``}
                    </div>

                    ${timeText ? `<div class="task-date">${timeText}</div>` : ``}
                  </div>
                </div>
              `;
            }).join('');
          }

          async function fetchTasks(dateStr) {
            if (cache.has(dateStr)) return cache.get(dateStr);

            if (inflightAbort) inflightAbort.abort();
            inflightAbort = new AbortController();

            const url = `/api/tasks?type=DAY&date=${encodeURIComponent(dateStr)}`;
            const res = await fetch(url, {
              headers: { 'Accept': 'application/json' },
              signal: inflightAbort.signal
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const body = await res.json();
            if (!body) throw new Error('ÏùëÎãµÏù¥ ÎπÑÏñ¥ÏûàÏùå');
            if (body.success === false) throw new Error(body.message || 'API Ïã§Ìå®');

            const raw = body.data ?? [];
            cache.set(dateStr, raw);
            return raw;
          }

          async function load(dateStr, { pushHistory } = { pushHistory: false }) {
            if (!dateStr || dateStr === currentDate) return;
            if (navigating) return;
            navigating = true;

            const mySeq = ++requestSeq;

            try {
              currentDate = dateStr;
              updateHeader(dateStr);

              if (pushHistory) {
                const newUrl = `/tasks/day?date=${encodeURIComponent(dateStr)}`;
                history.pushState({ date: dateStr }, '', newUrl);
              }

              hideAllState();
              $list.innerHTML = '';

              const raw = await fetchTasks(dateStr);

              if (mySeq !== requestSeq) return;

              const filtered = raw.filter(t => occursOn(t, dateStr));
              const sorted = sortTasks(filtered, dateStr);

              if (!sorted.length) {
                showEmpty();
                return;
              }

              const html = buildCardsHtml(sorted, dateStr);
              showList(html);
            } catch (e) {
              if (e.name === 'AbortError') return;
              if (mySeq !== requestSeq) return;
              showError(`ÏùºÏ†ï Î°úÎî© Ïã§Ìå®: ${e.message}`);
            } finally {
              setTimeout(() => { navigating = false; }, 50);
            }
          }

          function addDays(dateStr, delta) {
            const d = new Date(dateStr + 'T00:00:00');
            d.setDate(d.getDate() + delta);
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
          }

          $prev.addEventListener('click', (e) => {
            e.preventDefault();
            load(addDays(currentDate, -1), { pushHistory: true });
          });

          $next.addEventListener('click', (e) => {
            e.preventDefault();
            load(addDays(currentDate, +1), { pushHistory: true });
          });

          window.addEventListener('popstate', (e) => {
            const d = e.state?.date;
            if (d) {
              navigating = false;
              load(d, { pushHistory: false });
            }
          });

          (async () => {
            const init = root.dataset.date;
            const mySeq = ++requestSeq;

            try {
              hideAllState();
              $list.innerHTML = '';

              const raw = await fetchTasks(init);
              if (mySeq !== requestSeq) return;

              const filtered = raw.filter(t => occursOn(t, init));
              const sorted = sortTasks(filtered, init);

              if (!sorted.length) {
                showEmpty();
                return;
              }

              const html = buildCardsHtml(sorted, init);
              showList(html);
            } catch (e) {
              if (e.name === 'AbortError') return;
              showError(`ÏùºÏ†ï Î°úÎî© Ïã§Ìå®: ${e.message}`);
            }
          })();
        })();
    </script>

</div>

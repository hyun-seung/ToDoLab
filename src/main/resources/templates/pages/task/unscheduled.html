<!-- src/main/resources/templates/pages/task/unscheduled.html -->
<div id="unscheduled-page"
     th:fragment="content"
     class="px-4 pb-24 max-w-3xl mx-auto">

    <!-- ë¡œë”©/ì—ëŸ¬ -->
    <div id="unscheduled-loading" class="mt-6 text-gray-500 text-sm">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div id="unscheduled-error" class="mt-6 text-red-600 text-sm hidden"></div>

    <!-- Empty State (ì¤‘ì•™ ì •ë ¬) -->
    <div id="unscheduled-empty"
         class="hidden mt-16 flex flex-col items-center justify-center text-center select-none">
        <div class="w-14 h-14 rounded-2xl bg-white/60 border border-gray-200
                    flex items-center justify-center shadow-sm">
            <span class="text-2xl">ğŸ—‚ï¸</span>
        </div>

        <div class="mt-5 text-2xl font-extrabold text-gray-800">
            ì•„ì§ â€œë¯¸ì • ì¼ì •â€ì´ ì—†ì–´ìš”
        </div>

        <div class="mt-3 text-base text-gray-500 font-semibold">
            ì–¸ì œ í•  ì§€ ì •í•´ì§€ì§€ ì•Šì€ ì¼ì •ë“¤ì„ ëª¨ì•„ë´ìš”
        </div>
    </div>

    <!-- ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ -->
    <div id="unscheduled-card" class="mt-6 task-card hidden">
        <div class="flex items-center justify-between px-4 pt-4 pb-2">
            <div class="text-sm font-extrabold text-gray-400">ë¯¸ì • ì¼ì •</div>
            <div id="unscheduled-count"
                 class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded-full hidden"></div>
        </div>

        <div id="unscheduled-list" class="divide-y"></div>
    </div>

    <script>
        (() => {
          const root = document.getElementById('unscheduled-page');
          if (!root) return;

          const $loading = document.getElementById('unscheduled-loading');
          const $error = document.getElementById('unscheduled-error');
          const $empty = document.getElementById('unscheduled-empty');
          const $card = document.getElementById('unscheduled-card');
          const $list = document.getElementById('unscheduled-list');
          const $count = document.getElementById('unscheduled-count');

          function hideAll() {
            $loading.classList.add('hidden');
            $error.classList.add('hidden');
            $empty.classList.add('hidden');
            $card.classList.add('hidden');
          }

          function showError(msg) {
            hideAll();
            $error.textContent = msg;
            $error.classList.remove('hidden');
          }

          function showEmpty() {
            hideAll();
            $empty.classList.remove('hidden');
          }

          function showList() {
            hideAll();
            $card.classList.remove('hidden');
          }

          function escapeHtml(s) {
            return String(s ?? '')
              .replaceAll('&', '&amp;')
              .replaceAll('<', '&lt;')
              .replaceAll('>', '&gt;')
              .replaceAll('"', '&quot;')
              .replaceAll("'", '&#039;');
          }

          function badgeCategory(cat) {
            if (!cat) return '';
            const safe = escapeHtml(cat);
            return `<span class="text-[11px] px-2 py-1 rounded-full bg-gray-100 text-gray-700">${safe}</span>`;
          }

          function sortTasks(tasks) {
            // ìµœì‹  ìƒì„±ì¼ ìš°ì„  â†’ title
            return [...tasks].sort((a, b) => {
              const ca = a.createdAt ?? '';
              const cb = b.createdAt ?? '';
              if (ca !== cb) return ca < cb ? 1 : -1;

              const at = (a.title ?? '').toLowerCase();
              const bt = (b.title ?? '').toLowerCase();
              if (at === bt) return 0;
              return at < bt ? -1 : 1;
            });
          }

          function render(tasks) {
            if (!tasks || tasks.length === 0) {
              showEmpty();
              return;
            }

            showList();

            if ($count) {
              $count.textContent = `${tasks.length}ê°œ`;
              $count.classList.remove('hidden');
            }

            $list.innerHTML = tasks.map(t => {
              const title = escapeHtml(t.title);
              const desc = escapeHtml(t.description);
              const categoryHtml = badgeCategory(t.category);

              const created = (t.createdAt && typeof t.createdAt === 'string')
                ? escapeHtml(t.createdAt.split('T')[0])
                : '';

              const leftBarStyle = `style="background: rgba(99, 102, 241, 0.55);"`;

              return `
                <div class="task-row cursor-pointer hover:bg-gray-50"
                     data-task-id="${t.id}">
                  <div class="task-left-bar" ${leftBarStyle}></div>

                  <div class="check-box">âœ“</div>

                  <div class="min-w-0 flex-1">
                    <div class="flex items-center gap-2">
                      <div class="task-title truncate">${title}</div>
                      ${categoryHtml}
                    </div>
                    ${desc ? `<div class="task-desc mt-1 line-clamp-2">${desc}</div>` : ``}
                    ${created ? `<div class="task-time mt-2">ë“±ë¡ì¼ Â· ${created}</div>` : ``}
                  </div>

                  <div class="task-date">ë¯¸ì •</div>
                </div>
              `;
            }).join('');
          }

          async function load() {
            try {
              $loading.classList.remove('hidden');
              $error.classList.add('hidden');

              const url = `/api/tasks/unscheduled`;
              const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
              if (!res.ok) throw new Error(`HTTP ${res.status}`);

              const body = await res.json(); // ApiResponse<List<TaskResponse>>
              if (!body) throw new Error('ì‘ë‹µì´ ë¹„ì–´ìˆìŒ');
              if (body.success === false) throw new Error(body.message || 'API ì‹¤íŒ¨');

              const raw = body.data ?? [];
              const onlyUnscheduled = raw.filter(t => t && t.unscheduled === true);
              const sorted = sortTasks(onlyUnscheduled);

              render(sorted);
            } catch (e) {
              showError(`ë¯¸ì • ì¼ì • ë¡œë”© ì‹¤íŒ¨: ${e.message}`);
            } finally {
              $loading.classList.add('hidden');
            }
          }

          load();
        })();
    </script>
</div>

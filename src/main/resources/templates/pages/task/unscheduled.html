<!-- src/main/resources/templates/pages/task/unscheduled.html -->
<div id="unscheduled-page"
     th:fragment="content"
     class="px-4 pb-24 max-w-3xl mx-auto">

    <!-- ë¡œë”©/ì—ëŸ¬ -->
    <div id="unscheduled-loading" class="mt-6 text-gray-500 text-sm">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div id="unscheduled-error" class="mt-6 text-red-600 text-sm hidden"></div>

    <!-- Empty State -->
    <div id="unscheduled-empty"
         class="hidden mt-16 flex flex-col items-center justify-center text-center select-none">
        <div class="w-14 h-14 rounded-2xl bg-white/60 border border-gray-200
                    flex items-center justify-center shadow-sm">
            <span class="text-2xl">ğŸ—‚ï¸</span>
        </div>

        <div class="mt-5 text-2xl font-extrabold text-gray-800">
            ì•„ì§ â€œë¯¸ì • ì¼ì •â€ì´ ì—†ì–´ìš”
        </div>

        <div class="mt-3 text-base text-gray-500 font-semibold">
            ì–¸ì œ í•  ì§€ ì •í•´ì§€ì§€ ì•Šì€ ì¼ì •ë“¤ì„ ëª¨ì•„ë´ìš”
        </div>
    </div>

    <!-- ë¦¬ìŠ¤íŠ¸ -->
    <div id="unscheduled-list-wrap" class="mt-6 hidden">
        <div class="task-card">
            <div class="flex items-center justify-between px-4 pt-4 pb-2">
                <div class="text-sm font-extrabold text-gray-400">ë¯¸ì • ì¼ì •</div>
                <div id="unscheduled-count"
                     class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded-full hidden"></div>
            </div>

            <div id="unscheduled-list" class="space-y-0"></div>
        </div>
    </div>

    <script>
        (() => {
          const root = document.getElementById('unscheduled-page');
          if (!root) return;

          if (root.dataset.bound === "1") return;
          root.dataset.bound = "1";

          const $loading = document.getElementById('unscheduled-loading');
          const $error = document.getElementById('unscheduled-error');
          const $empty = document.getElementById('unscheduled-empty');
          const $wrap = document.getElementById('unscheduled-list-wrap');
          const $list = document.getElementById('unscheduled-list');
          const $count = document.getElementById('unscheduled-count');

          function hideAll() {
            $loading.classList.add('hidden');
            $error.classList.add('hidden');
            $empty.classList.add('hidden');
            $wrap.classList.add('hidden');
          }

          function showError(msg) {
            hideAll();
            $error.textContent = msg;
            $error.classList.remove('hidden');
          }

          function showEmpty() {
            hideAll();
            $empty.classList.remove('hidden');
          }

          function showList() {
            hideAll();
            $wrap.classList.remove('hidden');
          }

          function sortTasks(tasks) {
            return [...tasks].sort((a, b) => {
              const ca = a.createdAt ?? '';
              const cb = b.createdAt ?? '';
              if (ca !== cb) return ca < cb ? 1 : -1;

              const at = (a.title ?? '').toLowerCase();
              const bt = (b.title ?? '').toLowerCase();
              return at.localeCompare(bt);
            });
          }

          function render(tasks) {
            if (!tasks || tasks.length === 0) {
              showEmpty();
              return;
            }

            showList();

            $count.textContent = `${tasks.length}ê°œ`;
            $count.classList.remove('hidden');

            $list.innerHTML = tasks.map(t => {
              const created = (t.createdAt && typeof t.createdAt === 'string')
                ? (t.createdAt.split('T')[0])
                : '';

              return TaskUI.renderTaskCard({
                id: t.id,
                title: t.title,
                description: (t.description || '').trim() || null,
                category: (t.category || '').trim() || null,
                rightText: 'ë¯¸ì •',
                metaText: created ? `ë“±ë¡ì¼ Â· ${created}` : null
              });
            }).join('');
          }

          async function load() {
            try {
              $loading.classList.remove('hidden');
              $error.classList.add('hidden');

              const res = await fetch('/api/tasks/unscheduled', { headers: { 'Accept': 'application/json' } });
              if (!res.ok) throw new Error(`HTTP ${res.status}`);

              const body = await res.json();
              if (!body) throw new Error('ì‘ë‹µì´ ë¹„ì–´ìˆìŒ');
              if (body.success === false) throw new Error(body.message || 'API ì‹¤íŒ¨');

              const raw = body.data ?? [];
              const only = raw.filter(t => t && t.unscheduled === true);
              render(sortTasks(only));
            } catch (e) {
              showError(`ë¯¸ì • ì¼ì • ë¡œë”© ì‹¤íŒ¨: ${e.message}`);
            } finally {
              $loading.classList.add('hidden');
            }
          }

          load();
        })();
    </script>
</div>
